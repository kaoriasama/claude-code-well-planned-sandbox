# Planning Flow

## このドキュメントの性質

タスクの事前計画を対話的に策定するためのフレームワーク。
Claude（Agent）がフェーズを順に進行しながら、ユーザーと対話して計画を練り上げる。

## Agent の振る舞い規則

### 判断の原則

Agent はこのフローを機械的にたどるのではなく、タスクの性質に応じて判断する。

- **省略**: 明らかに不要な項目はスキップしてよい。スキップした場合、その旨と理由を簡潔に述べる。
- **跳躍**: 後のフェーズの観点が先に必要になった場合、フェーズを跨いで先取りしてよい。
- **回帰**: 後のフェーズで前提が崩れた場合、該当する観点のみ前のフェーズに戻って再検討する（フェーズ全体の巻き戻しではない）。
- **中止**: Phase 0 の段階で「計画不要」と判断した場合（自明なタスク、単発の質問等）、このフローを使わずに直接実行してよい。

### 対話の原則

- 各フェーズの要点をユーザーに提示し、判断を仰ぐ。一方的に埋めて結論を出さない。
- ユーザーが即答できない問いは保留にし、後のフェーズで情報が揃ってから戻る。
- 計画の全体像が見えた段階で、計画のサマリーを提示し、明示的な承認を得てから実行に移る。

### 記録の原則

- 計画の最終版は、タスクのワークスペース内にファイルとして保存する（形式は状況に応じて判断）。
- 計画からの逸脱が生じた場合、逸脱の内容と理由を記録する。

---

## Phase 0: 理解と調査

### 0-1: 目的の把握

- 何を達成したいか、一文で言語化する。
- なぜそれを達成したいか（動機が曖昧だとスコープが膨張する）。
- 成功とは何か、失敗とは何か。

### 0-2: 調査

必要な知識が不足している場合にのみ実施する。

- このタスクに必要で、現時点で不足している知識は何か。
- 調査する場合：範囲・深さ・完了条件を先に決める。
- 類似タスクの先行事例はあるか。
- 調査が大規模になる場合：コストを概算し、手段を選択する（内部知識／検索／DeepResearch）。

### 0-3: 目的の再定義

- 調査結果を踏まえ、目的を具体化・修正する。
- スコープの境界を明示する（やること／やらないこと）。

### 0-4: 目的の規範確認

該当する場合のみ。設計に入る前の門番。

- この目的自体に倫理的・法的な問題はないか。
- 倫理審査が必要な研究か。
- 所属機関の規定に抵触しないか。

問題がある場合 → 目的を修正するか、撤退する。

---

## Phase 1: 設計

### 1-1: 前提の明示

- この計画が成立するために仮定していることは何か。
- 各仮定の確度（確実／高い／不確実）。
- 不確実な仮定が崩れた場合、計画はどう変わるか。

### 1-2: アプローチの探索と選択

- 検討した代替アプローチとその評価。
  - 評価軸の例：安全性、実現可能性、品質、所要時間、保守性。
- 選択したアプローチとその根拠。
- 不確実性が最も高い部分とその検証方法。

### 1-3: 分解と構造化

- タスクをステップに分解する。
- 各ステップの目的と完了条件。
- ステップ間の依存関係。
- 抽象度の点検：過剰に詳細でも過剰に抽象でもないか。

### 1-4: 対話設計

サンドボックス環境（許可制）での承認フローを設計する。

- ユーザーに承認を求めるポイントはどこか。
- 承認の粒度は適切か（細かすぎ → 承認疲れ、粗すぎ → 制御喪失）。
- 各承認ポイントでユーザーに提示すべき情報は何か。
- 計画変更が必要になった場合の伝達方法。

---

## Phase 2: リスクと制御

### 2-1: リスクの特定と対処

リスクと対処法を一対で記述する。以下を含む。

技術的リスク：
- 想定される失敗モードとその対処。
- エッジケースへの対処。
- 部分的成功の扱い方。

規範的リスク（該当するもののみ）：
- 使用データの著作権・ライセンス。
- ツール・API の利用規約との整合性。
- 個人情報の取り扱い。
- AI 生成物の帰属表示・所属機関の AI 利用規定。
- 成果物公開時の引用適切性・社会的許容性。

### 2-2: リソース見積もり

- 時間・トークン・API 呼び出し数の見積もりと根拠。
- 見積もりに対するバッファ（1.5〜2倍を推奨）。

### 2-3: フェイルセーフ

- 最低限の成果（Minimum Viable Output）は何か。
- リソース不足時の縮小戦略（何を削るか、優先順位）。
- 大規模タスクの場合：セッション分割の区切りと中間成果物の定義。
- 計画を破棄すべき条件（撤退基準）。

### 2-4: 安全策

- ロールバックが困難なステップはどれか → その直前で何を保存するか。
- 人間の判断を仰ぐべき判断ポイント（1-4 と統合して考える）。
- 複数セッションにまたがる場合：中断時に保存すべき状態情報。

---

## Phase 3: 検証と承認

### 3-1: 計画の自己検証

- 計画はスコープに対して過大／過小でないか。
- 確証バイアスの点検：望む結論に向けて歪んでいないか。
- 最も失敗しやすいステップはどれか、なぜか。

### 3-2: ユーザーへの提示と承認

計画のサマリーをユーザーに提示する。サマリーには以下を含める。

- 目的（一文）
- アプローチの概要
- ステップの一覧（承認ポイントを明示）
- 主要なリスクとトレードオフ
- 所要時間の見積もり

ユーザーの承認を得てから実行に移る。

---

## Phase 4: 実行中プロトコル

計画段階で以下を定義しておく。実行中に参照する。

### 4-1: 進捗報告

- 報告のタイミングと形式（ステップ完了ごと、等）。

### 4-2: 計画逸脱時の対応

計画と実態が乖離した場合の手順：

1. 乖離を検知する（指標を事前に定める）。
2. 継続可否を判断する（基準を事前に定める）。
3. 計画修正が必要な場合 → 修正案をユーザーに提示し、再承認を得る。

---

## Phase 5: 完了と振り返り

実行完了後に行う。

### 5-1: 完了判定

- Phase 0-1 で設定した成功の定義と成果物の照合。
- 成果物の品質評価。

### 5-2: 振り返り

- 計画と実行の差異は何だったか、原因は何か。
- CLAUDE.md の Lessons Learned に追記すべきことはあるか。
- この計画フロー自体に改善点はあるか。
